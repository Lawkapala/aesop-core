(function(a){tinymce.PluginManager.add("aiview",function(j){function l(p){return p.replace(/(\[aesop_([a-zA-Z_]+)\s([^\[\]]*)]([^\[\]]+)\[\/aesop_[a-zA-Z_]+]|\[aesop_([a-zA-Z_]+)\s?([^\[\]]*)])/g,function(q){return h("aesop-component",q)})}function h(p,u){var s=/\[aesop_([a-zA-Z_]+)\s([^\[\]]*)]([^\[\]]+)\[\/aesop_[a-zA-Z_]+]/g;var t=/\[aesop_([a-zA-Z_]+)\s?([^\[\]]*)]/g;var r=/(<\/p>[\s]*<p><\/p>\s<p>)[\s]*$/;var w=/(<\/p>[\s]*<p>)[\s]*$/;var v=s.exec(u);if(!v){v=t.exec(u);var q='<div data-mce-resize="false" data-mce-placeholder="1" data-aesop-sc="'+window.encodeURIComponent(u)+'" class="mceItem aesop-component-short '+p+'"><div class="aesop-component-mask mceNonEditable unselectable" contenteditable="false"></div><div class="aesop-component-bar" contenteditable="false"><div class="aesop-component-controls"><div title="Delete Component" class="aesop-button aesop-button-delete">&nbsp;</div><div title="Clone Component" class="aesop-button aesop-button-clone">&nbsp;</div><div title="Edit Component" class="aesop-button aesop-button-edit aesop-scope-'+v[1]+'">&nbsp;</div><div title="Cut Component / CTRL + ALT + ENTER to Paste" class="aesop-button aesop-button-clipboard">&nbsp;</div></div><span class="mceNonEditable aesop-component-title unselectable aesop-'+v[1]+'-title">'+v[1].replace(/_/g," ")+'</span></div><div class="aesop-end">WcMgcq</div></div>'}else{v[3]=v[3].replace(r,"");v[3]=v[3].replace(w,"");var q='<div data-mce-resize="false" data-mce-placeholder="1" data-aesop-sc="'+window.encodeURIComponent(u)+'" class="mceItem aesop-component-long '+p+'"><div class="aesop-component-mask mceNonEditable unselectable" contenteditable="false"></div><div class="aesop-component-bar" contenteditable="false"><div class="aesop-component-controls"><div title="Delete Component" class="aesop-button aesop-button-delete">&nbsp;</div><div title="Clone Component" class="aesop-button aesop-button-clone">&nbsp;</div><div title="Edit Component" class="aesop-button aesop-button-edit aesop-scope-'+v[1]+'">&nbsp;</div><div title="Cut Component / CTRL + ALT + ENTER to Paste" class="aesop-button aesop-button-clipboard">&nbsp;</div></div><span class="mceNonEditable aesop-component-title unselectable aesop-'+v[1]+'-title">'+v[1].replace(/_/g," ")+'</span></div><div class="aesop-component-content aesop-'+v[1]+'"><p>'+v[3]+"</p></div></div>"}return q}function e(p){return p.replace((/<div[^>]+?class="[^"]+?aesop-component-long.*?aesop-sc="([^"]+)"[\s\S]*?aesop-component-content[^>]*?>(.*?)<\/div>[\s]*?<\/div>|<div class="[^"+]+?aesop-component-short.*?aesop-sc="([^"]+)"[\s\S]*?WcMgcq<\/div><\/div>/g),function(q){return g(q)})}function g(p){var r=/<div[^>]+?class="[^"]+?aesop-component.*?aesop-sc="([^"]+)"[\s\S]*?aesop-component-content[^>]*?>(.*?)<\/div>[\s]*?<\/div>/g;var t=/<div class="[^"+]+?aesop-component.*?aesop-sc="([^"]+)"[\s\S]*?WcMgcq<\/div><\/div>/g;var w=/<div\s*class="clipboardControl[^>]+?><div\s*class="aesop[^>]+>\s*<\/div><\/div>/g;p=p.replace(w,"");var v=r.exec(p);if(!v){v=t.exec(p);if(!v){return p}var u=window.decodeURIComponent(v[1]);return"<p>"+u+"</p>"}else{var u=window.decodeURIComponent(v[1]);var q=/\[[^\]]*\]([^\[]*)[^\]]*\]/;var s=q.exec(u);if(s!=null){v[2]=v[2].replace(/^<p>\W<\/p>/,"");u=u.replace(s[1],v[2])}return"<p>"+u+"</p>"}}function f(t){var q=/\[aesop_([a-zA-Z_]+)\s([^\[\]]*)]([^\[\]]+)\[\/aesop_[a-zA-Z]+]/g;var u=/\[aesop_([a-zA-Z_]+)\s([^\[\]]*)]/g;var p=/<br data-mce-bogus="1">/g;var r=/([^\s]+="[^"]+")/g;var v=/([^\s]+)\s?/g;var s=q.exec(t);if(!s){s=u.exec(t);if(!s){return t}}var y;var w=[];while((y=r.exec(s[2]))!==null){w.push(y[1])}var x=[];w.forEach(function(z){z=z.split("=");var B=z[0];var A=z[1];A=A.slice(0,-1);x[B]=A.substring(1)});if(typeof s[3]!=="undefined"){x.content=s[3].replace(p,"")}return x}function k(p){p.parentNode.removeChild(p)}function b(p){if(p.style.display!=="none"){p.style.display="none"}}function m(p){if(p.style.display!=="block"){p.style.display="block"}}function i(p){var q=timymce.activeEditor.dom.select("."+p)}function n(s){window.clipboardSource=s;var q=tinymce.activeEditor;var r=q.dom.create("div",{"class":"clipboardControl mceNonEditable unselectable"},'<div class="aesop-button aesop-button-paste mceNonEditable unselectable" title="Ctrl + Alt + Enter to Paste">&nbsp;</div>');q.getBody().insertBefore(r,q.getBody().firstChild);window.clipboardControl=a(r)}function d(){var p=tinymce.activeEditor;var q=p.dom.select(".clipboardControl");p.dom.remove(q);delete window.clipboard;delete window.clipboardSource;delete window.clipboardControl}function c(){var r=window.clipboardSource;var q=tinymce.activeEditor;q.dom.remove(r);m(window.clipboard);q.execCommand("mceInsertRawHTML",false,window.clipboard.outerHTML);d()}function o(r){var q=tinymce.activeEditor;jQuery(r.outerHTML).insertAfter(r)}jQuery.fn.setCursorPosition=function(p){if(this.length==0){return this}return a(this).setSelection(p,p)};jQuery.fn.setSelection=function(q,r){if(this.length==0){return this}input=this[0];if(input.createTextRange){var p=input.createTextRange();p.collapse(true);p.moveEnd("character",r);p.moveStart("character",q);p.select()}else{if(input.setSelectionRange){input.focus();input.setSelectionRange(q,r)}}return this};jQuery.fn.focusEnd=function(){this.setCursorPosition(this.val().length);return this};j.onClick.add(function(s,t){delete window.ailocked;delete window.aiactive;if(typeof a(s.selection.getNode()).parents(".aesop-component")[0]!=="undefined"){window.aiactive=true}if(t.target.className.indexOf("aesop-button-delete")>-1){var u=confirm("Are you sure you want to delete this Aesop Component?");if(u===true){t.target.parentNode.parentNode.parentNode.parentNode.removeChild(t.target.parentNode.parentNode.parentNode)}delete window.aiactive;window.ailocked=true;tinymce.execCommand("mceFocus",false,s.id)}if(t.target.className.indexOf("aesop-button-edit")>-1){var q=/aesop-scope-([a-z_]*)/;var y=q.exec(t.target.className);var r=t.target.parentNode.parentNode.parentNode;var v=e(r.outerHTML);r.setAttribute("id","aesop-generator-editing");if(y){a("body").toggleClass("modal-open");a("body").addClass("modal-updating");a("#aesop-generator-wrap").toggleClass("aesop-generator-open");var p=".dk_options li."+y[1]+" a";a(p).click();var x=f(v);for(var w in x){if(w==="content"){a("#aesop-generator-content").val(x[w])}else{a('#aesop-generator-settings [name="'+w+'"]').val(x[w])}}}s.selection.collapse(false)}if(t.target.className.indexOf("aesop-button-clipboard")>-1){var r=t.target.parentNode.parentNode.parentNode;window.clipboard=r;b(r);n(r);s.selection.collapse(false)}if(t.target.className.indexOf("aesop-button-clone")>-1){var r=t.target.parentNode.parentNode.parentNode;o(r);s.selection.collapse(false)}});j.onKeyDown.add(function(q,u){delete window.ailocked;if(u.keyCode===13&&!u.ctrlKey&&!u.shiftKey&&!u.altKey){var p=q.selection.getNode();var r=a(p).parents(".aesop-component");if(a(p).parents(".aesop-component")[0]){u.preventDefault();u.stopPropagation();var t=a("<p><br/></p>").insertAfter(r);t.uniqueId();var v=t.attr("id");var s=q.dom.select("#"+v)[0];q.selection.setCursorLocation(s)}}if(u.ctrlKey&&u.altKey&&u.keyCode===13){u.preventDefault();u.stopPropagation();if(typeof window.clipboard==="undefined"){alert("Clipboard is empty")}else{if(typeof window.aiactive!=="undefined"){alert("Please do not paste into an existing aesop component")}else{c()}}}});j.onKeyUp.add(function(p,q){if(typeof a(p.selection.getNode()).parents(".aesop-component")[0]!=="undefined"){window.aiactive=true}else{delete window.aiactive}});j.on("BeforeSetContent",function(p){p.content=l(p.content)});j.on("PostProcess",function(p){if(p.get){p.content=e(p.content)}})})})(window.jQuery);