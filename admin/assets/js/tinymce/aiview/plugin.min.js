(function(a){tinymce.PluginManager.add("aiview",function(j){function l(o){return o.replace(/(\[aesop_([a-zA-Z_]+)\s([^\[\]]*)]([^\[\]]+)\[\/aesop_[a-zA-Z_]+]|\[aesop_([a-zA-Z_]+)\s?([^\[\]]*)])/g,function(p){return h("aesop-component",p)})}function h(o,s){var q=/\[aesop_([a-zA-Z_]+)\s([^\[\]]*)]([^\[\]]+)\[\/aesop_[a-zA-Z_]+]/g;var r=/\[aesop_([a-zA-Z_]+)\s?([^\[\]]*)]/g;var t=q.exec(s);if(!t){t=r.exec(s);var p='<div data-mce-resize="false" data-mce-placeholder="1" data-aesop-sc="'+window.encodeURIComponent(s)+'" class="mceItem aesop-component-short '+o+'"><div class="aesop-component-mask"></div><div class="aesop-component-bar" contenteditable="false"><div class="aesop-component-controls"><div title="Delete Component" class="aesop-button aesop-button-delete">&nbsp;</div><div title="Edit Component" class="aesop-button aesop-button-edit aesop-scope-'+t[1]+'">&nbsp;</div><div title="Cut Component / CTRL + ALT + ENTER to Paste" class="aesop-button aesop-button-clipboard">&nbsp;</div></div><span class="mceNonEditable aesop-component-title unselectable aesop-'+t[1]+'-title">'+t[1].replace(/_/g," ")+'</span></div><div class="aesop-end">WcMgcq</div></div>'}else{var p='<div data-mce-resize="false" data-mce-placeholder="1" data-aesop-sc="'+window.encodeURIComponent(s)+'" class="mceItem aesop-component-long '+o+'"><div class="aesop-component-mask"></div><div class="aesop-component-bar"  contenteditable="false"><div class="aesop-component-controls"><div title="Delete Component" class="aesop-button aesop-button-delete">&nbsp;</div><div title="Edit Component" class="aesop-button aesop-button-edit aesop-scope-'+t[1]+'">&nbsp;</div><div title="Cut Component / CTRL + ALT + ENTER to Paste" class="aesop-button aesop-button-clipboard">&nbsp;</div></div><span class="mceNonEditable aesop-component-title unselectable aesop-'+t[1]+'-title">'+t[1].replace(/_/g," ")+'</span></div><div class="aesop-component-content aesop-'+t[1]+'"><p>'+t[3]+"</p></div></div>";console.log(p)}return p}function e(o){return o.replace((/<div[^>]+?class="[^"]+?aesop-component-long.*?aesop-sc="([^"]+)"[\s\S]*?aesop-component-content[^>]*?>(.*?)<\/div>[\s]*?<\/div>|<div class="[^"+]+?aesop-component-short.*?aesop-sc="([^"]+)"[\s\S]*?WcMgcq<\/div><\/div>/g),function(p){return g(p)})}function g(o){var q=/<div[^>]+?class="[^"]+?aesop-component.*?aesop-sc="([^"]+)"[\s\S]*?aesop-component-content[^>]*?>(.*?)<\/div>[\s]*?<\/div>/g;var s=/<div class="[^"+]+?aesop-component.*?aesop-sc="([^"]+)"[\s\S]*?WcMgcq<\/div><\/div>/g;var v=/<div\s*class="clipboardControl[^>]+?><div\s*class="aesop[^>]+>\s*<\/div><\/div>/g;o=o.replace(v,"");var u=q.exec(o);if(!u){u=s.exec(o);if(!u){return o}var t=window.decodeURIComponent(u[1]);return"<p>"+t+"</p>"}else{var t=window.decodeURIComponent(u[1]);var p=/\[[^\]]*\]([^\[]*)[^\]]*\]/;var r=p.exec(t);if(r!=null){t=t.replace(r[1],u[2])}return"<p>"+t+"</p>"}}function f(s){var p=/\[aesop_([a-zA-Z_]+)\s([^\[\]]*)]([^\[\]]+)\[\/aesop_[a-zA-Z]+]/g;var t=/\[aesop_([a-zA-Z_]+)\s([^\[\]]*)]/g;var o=/<br data-mce-bogus="1">/g;var q=/([^\s]+="[^"]+")/g;var u=/([^\s]+)\s?/g;var r=p.exec(s);if(!r){r=t.exec(s);if(!r){return s}}var x;var v=[];while((x=q.exec(r[2]))!==null){v.push(x[1])}var w=[];v.forEach(function(y){y=y.split("=");var A=y[0];var z=y[1];z=z.slice(0,-1);w[A]=z.substring(1)});if(typeof r[3]!=="undefined"){w.content=r[3].replace(o,"")}return w}function k(o){o.parentNode.removeChild(o)}function b(o){if(o.style.display!=="none"){o.style.display="none"}}function m(o){if(o.style.display!=="block"){o.style.display="block"}}function i(o){var p=timymce.activeEditor.dom.select("."+o)}function n(r){window.clipboardSource=r;var o=tinymce.activeEditor;var q=o.dom.create("div",{"class":"clipboardControl mceNonEditable unselectable"},'<div class="aesop-button aesop-button-paste mceNonEditable unselectable" title="Ctrl + Alt + Enter to Paste">&nbsp;</div>');o.getBody().insertBefore(q,o.getBody().firstChild);window.clipboardControl=a(q)}function d(){var o=tinymce.activeEditor;var p=o.dom.select(".clipboardControl");o.dom.remove(p);delete window.clipboard;delete window.clipboardSource;delete window.clipboardControl}function c(){var q=window.clipboardSource;var o=tinymce.activeEditor;o.dom.remove(q);m(window.clipboard);o.execCommand("mceInsertRawHTML",false,window.clipboard.outerHTML);d()}j.onClick.add(function(r,s){delete window.ailocked;delete window.aiactive;if(typeof a(r.selection.getNode()).parents(".aesop-component")[0]!=="undefined"){window.aiactive=true}if(s.target.className.indexOf("aesop-button-delete")>-1){var t=confirm("Are you sure you want to delete this Aesop Component?");if(t===true){s.target.parentNode.parentNode.parentNode.parentNode.removeChild(s.target.parentNode.parentNode.parentNode)}delete window.aiactive;window.ailocked=true;tinymce.execCommand("mceFocus",false,r.id)}if(s.target.className.indexOf("aesop-button-edit")>-1){var p=/aesop-scope-([a-z_]*)/;var x=p.exec(s.target.className);var q=s.target.parentNode.parentNode.parentNode;var u=e(q.outerHTML);q.setAttribute("id","aesop-generator-editing");if(x){a("body").toggleClass("modal-open");a("#aesop-generator-wrap").toggleClass("aesop-generator-open");var o=".dk_options li."+x[1]+" a";a(o).click();var w=f(u);for(var v in w){if(v==="content"){a("#aesop-generator-content").val(w[v])}else{a('#aesop-generator-settings [name="'+v+'"]').val(w[v])}}}}if(s.target.className.indexOf("aesop-button-clipboard")>-1){var q=s.target.parentNode.parentNode.parentNode;window.clipboard=q;b(q);n(q)}});j.onKeyDown.add(function(p,t){delete window.ailocked;if(t.keyCode===13&&!t.ctrlKey&&!t.shiftKey&&!t.altKey){var o=p.selection.getNode();var q=a(o).parents(".aesop-component");if(a(o).parents(".aesop-component")[0]){t.preventDefault();t.stopPropagation();var s=a("<p><br/></p>").insertAfter(q);s.uniqueId();var u=s.attr("id");var r=p.dom.select("#"+u)[0];p.selection.setCursorLocation(r)}}if(t.ctrlKey&&t.altKey&&t.keyCode===13){t.preventDefault();t.stopPropagation();if(typeof window.clipboard==="undefined"){alert("Clipboard is empty")}else{if(typeof window.aiactive!=="undefined"){alert("Please do not paste into an existing aesop component")}else{c()}}}});j.onKeyUp.add(function(o,p){if(typeof a(o.selection.getNode()).parents(".aesop-component")[0]!=="undefined"){window.aiactive=true}else{delete window.aiactive}});j.on("BeforeSetContent",function(o){o.content=l(o.content)});j.on("PostProcess",function(o){if(o.get){o.content=e(o.content)}})})})(window.jQuery);