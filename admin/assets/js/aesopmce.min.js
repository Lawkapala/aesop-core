(function(){tinymce.create("tinymce.plugins.visualShortcodes",{init:function(e,t){this.counter=0;var n=this,r,i,s=[];n.url=t;n._shortcodes=tinymce.i18n["visualShortcode.shortcodes"];if(!n._shortcodes||undefined===n._shortcodes.length||0==n._shortcodes.length)return;n.shortcodes={};for(r=0,i=n._shortcodes[r];r<n._shortcodes.length;i=n._shortcodes[++r]){if(undefined===i.shortcode||""==i.shortcode||undefined===i.image||""==i.image)continue;n.shortcodes[i.shortcode]=i;s.push(i.shortcode)}if(s.length<1)return;n._buildRegex(s);n._createButtons();e.onMouseDown.add(function(e,t){if(t.target.nodeName=="IMG"&&e.dom.hasClass(t.target,"jpbVisualShortcode")){var r=t.target.id.replace(/^vscImage\d+-(.+)$/,"$1");undefined!==n.shortcodes[r]&&undefined!==n.shortcodes[r].command?e.plugins.wordpress._showButtons(t.target,"jpb_vscbuttons"):e.plugins.wordpress._showButtons(t.target,"jpb_vscbutton")}else n._hideButtons()});e.onChange.add(function(e,t){if(!n.regex.test(t.content))return;t.content=n._doScImage(t.content);e.setContent(t.content);e.execCommand("mceRepaint")});e.onBeforeSetContent.add(function(e,t){if(!n.regex.test(t.content))return;t.content=n._doScImage(t.content)});e.onPostProcess.add(function(e,t){t.get&&(t.content=n._getScImage(t.content))});e.onInit.add(function(e){tinymce.dom.Event.add(e.getWin(),"scroll",function(e){n._hideButtons()});tinymce.dom.Event.add(e.getBody(),"dragstart",function(e){n._hideButtons()})})},_doScImage:function(e){var t=this;return e.replace(t.regex,function(e,n,r){return'<img src="'+t.shortcodes[n].image+'" id="vscImage'+t.counter++ +"-"+n+'" class="mceItem jpbVisualShortcode" title="'+n+tinymce.DOM.encode(r)+'" />'})},_getScImage:function(e){function t(e,t){t=(new RegExp(t+'="([^"]+)"',"g")).exec(e);return t?tinymce.DOM.decode(t[1]):""}return e.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(e,n){var r=t(n,"class");return r.indexOf("jpbVisualShortcode")!=-1?"<p>["+tinymce.trim(t(n,"title"))+"]</p>":e})},_buildRegex:function(e){var t=this,n="";n="\\[("+e.join("|")+")(( [^\\]]+)*)\\]";t.regex=new RegExp(n,"gi")},_hideButtons:function(){tinymce.DOM.hide("jpb_vscbuttons");tinymce.DOM.hide("jpb_vscbutton")},_createButtons:function(){var e=this,t=tinyMCE.activeEditor,n=tinyMCE.DOM,r,i,s;n.remove("jpb_vscbuttons");n.remove("jpb_vscbutton");n.add(document.body,"div",{id:"jpb_vscbuttons",style:"display:none;"});n.add(document.body,"div",{id:"jpb_vscbutton",style:"display:none;"});r=n.add("jpb_vscbuttons","img",{src:e.url+"/img/edit.png",id:"jpb_editshortcode",width:"24",height:"24",style:"margin:2px;"});tinymce.dom.Event.add(r,"mousedown",function(t){var n=tinyMCE.activeEditor,r=n.selection.getNode(),i=r.id.replace(/^vscImage\d+-(.+)$/,"$1");if(!i||undefined===e.shortcodes[i]||undefined===e.shortcodes[i].command)return;n.execCommand(e.shortcodes[i].command);e._hideButtons()});i=n.add("jpb_vscbuttons","img",{src:e.url+"/img/delete.png",id:"jpb_delshortcode",width:"24",height:"24",style:"margin:2px;"});s=n.add("jpb_vscbutton","img",{src:e.url+"/img/delete.png",id:"jpb_delshortcode2",width:"24",height:"24",style:"margin:2px;"});tinymce.dom.Event.add([i,s],"mousedown",function(t){var n=tinyMCE.activeEditor,r=n.selection.getNode(),i;if(r.nodeName=="IMG"&&n.dom.hasClass(r,"jpbVisualShortcode")){i=r.parentNode;n.dom.remove(r);n.execCommand("mceRepaint");e._hideButtons();n.selection.select(i);return!1}})}});tinymce.PluginManager.add("visualshortcodes",tinymce.plugins.visualShortcodes)})();